<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AktivitasKu - Your Personalized Learning Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Modern Glassmorphism and Animations */
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .floating-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .floating-shape {
            position: absolute;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 50%;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .slide-in {
            animation: slideIn 0.8s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 1s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .tab-button {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #374151;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 4px;
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .tab-button.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin: 12px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .learning-path-item {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .learning-path-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .learning-path-item.completed {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #28a745;
        }

        .learning-path-item.current {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-color: #ffc107;
        }

        .neon-glow {
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }

        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 193, 7, 0.5); }
            50% { box-shadow: 0 0 30px rgba(255, 193, 7, 0.8); }
        }

        .study-streak {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .study-session-timer {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 16px;
            color: white;
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            font-size: 14px;
            transition: all 0.3s ease;
            color: #374151;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-field:hover {
            border-color: #d1d5db;
        }

        .input-field::placeholder {
            color: #9ca3af;
        }

        /* Styling khusus untuk input di modal */
        .modal .input-field {
            border: 2px solid #d1d5db;
            background: white;
            color: #1f2937;
        }

        .modal .input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal .input-field:hover {
            border-color: #9ca3af;
        }

        .modal select.input-field {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
        }

        .chat-bubble {
            margin: 16px 0;
            padding: 16px;
            border-radius: 16px;
            animation: slideIn 0.3s ease-out;
        }

        .ai-message {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .user-message {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            max-width: 80%;
        }

        .skill-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .achievement-badge {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin: 4px 0;
            display: inline-block;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 16px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .calendar-day:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.05);
        }

        .calendar-day.today {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .calendar-day.selected {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .calendar-day.has-session {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: white;
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            stroke-dasharray: 125.6;
            transition: stroke-dashoffset 0.5s ease;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        /* Perbaiki warna teks select timer */
        #timerSelect {
            color: #1a202c;
            background: #fff;
        }
        #timerSelect:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="min-h-screen relative overflow-x-hidden">
    <!-- Name Input Modal -->
    <div id="nameModal" class="modal show">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">🎓 Selamat Datang di AktivitasKu!</h2>
            <p class="text-gray-600 mb-6">Silakan masukkan nama Anda untuk memulai perjalanan pembelajaran</p>
            <input type="text" id="nameInput" class="input-field mb-4" placeholder="Masukkan nama Anda..." onkeypress="handleNameKeyPress(event)">
            <button class="btn-primary w-full" onclick="saveName()">Mulai Belajar</button>
        </div>
    </div>

    <!-- Add Subject Modal -->
    <div id="subjectModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">📚 Tambah Mata Pelajaran Baru</h2>
            <div class="space-y-4">
                <input type="text" id="subjectName" class="input-field" placeholder="Nama mata pelajaran...">
                <textarea id="subjectDescription" class="input-field" rows="3" placeholder="Deskripsi mata pelajaran..."></textarea>
                <select id="subjectDifficulty" class="input-field">
                    <option value="beginner">Pemula</option>
                    <option value="intermediate">Menengah</option>
                    <option value="advanced">Lanjutan</option>
                </select>
                <p>Tambahkan durasi belajar:</p>
                <input type="number" id="subjectTime" class="input-field" placeholder="Durasi belajar (menit)" min="1" value="25">
                <div class="flex space-x-4">
                    <button class="btn-primary flex-1" onclick="addNewSubject()">Tambah</button>
                    <button class="btn-primary flex-1" onclick="closeSubjectModal()" style="background: linear-gradient(45deg, #6c757d, #495057);">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Background Elements -->
    <div class="floating-elements">
        <div class="floating-shape" style="top: 10%; left: 10%; width: 60px; height: 60px; animation-delay: 0s;"></div>
        <div class="floating-shape" style="top: 20%; right: 15%; width: 80px; height: 80px; animation-delay: 1s;"></div>
        <div class="floating-shape" style="bottom: 30%; left: 20%; width: 40px; height: 40px; animation-delay: 2s;"></div>
        <div class="floating-shape" style="bottom: 10%; right: 25%; width: 70px; height: 70px; animation-delay: 3s;"></div>
    </div>

    <!-- Header -->
    <header class="glass-morphism fixed top-0 left-0 right-0 z-50 slide-in">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center neon-glow">
                        <span class="text-white text-2xl font-bold">🧠</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-black">AktivitasKu</h1>
                        <p class="text-white/70 text-sm font-medium">Your Personalized Learning Assistant</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="study-streak pulse-glow">
                        🔥 <span id="studyStreak">0</span> Hari Streak
                    </div>
                    <button class="btn-primary" onclick="showProfile()">
                        <span>👤 Profil</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8 pt-28">
        <!-- Welcome Section -->
        <section class="mb-8 slide-in">
            <div class="glass-card rounded-3xl p-8 text-center">
                <h2 class="text-4xl font-bold text-gray-800 mb-4">
                    Selamat Datang, <span class="text-purple-600" id="userName">Siswa</span>! 🎓
                </h2>
                <p class="text-gray-600 text-lg mb-6">
                    Mari kita lanjutkan perjalanan pembelajaran Anda hari ini
                </p>
                <div class="flex justify-center space-x-4">
                    <div class="metric-card">
                        <div class="text-3xl font-bold text-purple-600 mb-2" id="overallProgress">0%</div>
                        <div class="text-gray-600 text-sm">Progres Belajar</div>
                    </div>
                    <div class="metric-card">
                        <div class="text-3xl font-bold text-green-600 mb-2" id="completedCourses">0</div>
                        <div class="text-gray-600 text-sm">Kursus Selesai</div>
                    </div>
                    <div class="metric-card">
                        <div class="text-3xl font-bold text-blue-600 mb-2" id="studyTime">0h</div>
                        <div class="text-gray-600 text-sm">Waktu Belajar</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Navigation Tabs -->
        <div class="glass-morphism rounded-3xl p-6 mb-8 fade-in">
            <div class="flex justify-center space-x-4 flex-wrap">
                <button class="tab-button active" onclick="showTab('dashboard')">📊 Dashboard</button>
                <!-- <button class="tab-button" onclick="showTab('learning-path')">🎯 Learning Path</button> -->
                <button class="tab-button" onclick="showTab('ai-tutor')">💬 Chatbot EduMentor</button>
                <button class="tab-button" onclick="showTab('study-planner')">📅 Perencana Belajar</button>
                <button class="tab-button" onclick="showTab('analytics')">�� Analitik</button>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Jadwal Hari Ini -->
                <div class="lg:col-span-2">
                    <div class="glass-card rounded-3xl p-8 mb-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">📅 Jadwal Hari Ini</h3>
                            <div id="selectedActions" class="flex space-x-2" style="display:none">
                                <button class="btn-primary" onclick="deleteSelectedSubjects()" style="background: linear-gradient(45deg, #ff0000, #ff4444);">Hapus Terpilih</button>
                                <button class="btn-primary" onclick="resetSelectedSubjects()" style="background: linear-gradient(45deg, #f59e42, #fbbf24);">Reset Terpilih</button>
                            </div>
                            <button class="btn-primary" onclick="openSubjectModal()">+ Tambah Mata Pelajaran</button>
                        </div>
                        <div class="space-y-4" id="todaySchedule">
                            <!-- Schedule items will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Quick Actions & Stats -->
                <div class="space-y-6">
                    <!-- Study Timer -->
                    <div class="glass-card rounded-3xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">⏱️ Timer Belajar</h3>
                        <div class="study-session-timer">
                            <div id="activeSubjectName" class="mb-2 text-lg font-semibold text-white"></div>
                            <select id="timerSelect" class="input-field mb-2" onchange="changeTimerDuration()">
                                <option value="20">20 menit</option>
                                <option value="25" selected>25 menit</option>
                                <option value="30">30 menit</option>
                            </select>
                            <div class="text-3xl font-bold mb-2" id="timerDisplay">25:00</div>
                            <div class="text-sm opacity-80 mb-4">Sesi Fokus</div>
                            <div class="flex justify-center space-x-2">
                                <button class="btn-primary" onclick="startTimer()" id="timerBtn">Mulai</button>
                                <button class="btn-primary" onclick="resetTimer()" style="background: linear-gradient(45deg, #ef4444, #dc2626);">Reset</button>
                            </div>
                        </div>
                    </div>

                    <!-- AI Recommendations -->
                    <div class="glass-card rounded-3xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">💡 Rekomendasi</h3>
                        <div class="space-y-3" id="aiRecommendations">
                            <!-- AI recommendations will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Learning Path Tab -->
        <div id="learning-path" class="tab-content">
            <div class="glass-card rounded-3xl p-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-6">🎯 Jalur Belajar Personalis Anda</h3>
                <div class="space-y-6" id="learningPaths">
                    <!-- Learning paths will be populated here -->
                </div>
            </div>
        </div>

        <!-- AI Tutor Tab -->
        <div id="ai-tutor" class="tab-content">
            <div class="glass-card rounded-3xl p-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-6">💬 Chatbot EduMentor - Tanya Jawab Cepat</h3>
                <!-- Chat Interface -->
                <div class="bg-gray-50 rounded-2xl p-6 mb-6" style="height: 400px; overflow-y: auto;" id="chatContainer">
                    <div class="chat-bubble ai-message">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                <span class="text-white text-sm">🤖</span>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-800 mb-1">EduMentor Chatbot</div>
                                <div class="text-gray-700">
                                    Silakan pilih pertanyaan di bawah. Jawaban akan langsung diberikan oleh chatbot EduMentor.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- FAQ Questions -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">💡 Pilih Pertanyaan</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="faqQuestions">
                        <!-- Pertanyaan akan diisi oleh JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Study Planner Tab -->
        <div id="study-planner" class="tab-content">
            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Calendar -->
                <div class="lg:col-span-2">
                    <div class="glass-card rounded-3xl p-8">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">📅 Kalender Belajar</h3>
                        
                        <!-- Calendar Header -->
                        <div class="flex justify-between items-center mb-6">
                            <button class="btn-primary" onclick="changeMonth(-1)">❮</button>
                            <h4 class="text-xl font-bold text-gray-800" id="calendarMonth">Juli 2025</h4>
                            <button class="btn-primary" onclick="changeMonth(1)">❯</button>
                        </div>

                        <!-- Calendar Grid -->
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Calendar will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Planner Controls -->
                <div class="space-y-6">
                    <!-- AI Schedule Generator -->
                    <div class="glass-card rounded-3xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">🤖 Perencana Jadwal AI</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Waktu Belajar Per Hari</label>
                                <select class="input-field" id="availableTime">
                                    <option value="2-3">2-3 jam</option>
                                    <option value="3-4">3-4 jam</option>
                                    <option value="4-5">4-5 jam</option>
                                    <option value="5+">5+ jam</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Gaya Belajar</label>
                                <select class="input-field" id="learningStyle">
                                    <option value="visual">Pembelajar Visual</option>
                                    <option value="auditory">Pembelajar Auditif</option>
                                    <option value="kinesthetic">Pembelajar Kinestetik</option>
                                    <option value="reading">Membaca/Menulis</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Prioritas Mata Pelajaran</label>
                                <select class="input-field" id="prioritySubject">
                                    <!-- Will be populated dynamically -->
                                </select>
                            </div>
                            <button class="btn-primary w-full" onclick="generateSchedule()">
                                Hasilkan Jadwal Optimal
                            </button>
                        </div>
                    </div>

                    <!-- Study Goals -->
                    <div class="glass-card rounded-3xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">�� Tujuan Belajar</h3>
                        <div class="space-y-3" id="studyGoals">
                            <!-- Goals will be populated here -->
                        </div>
                        <button class="btn-primary w-full mt-4" onclick="addNewGoal()">
                            + Tambah Tujuan Baru
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Learning Progress Chart -->
                <div class="glass-card rounded-3xl p-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">📊 Progres Belajar</h3>
                    <div class="space-y-4" id="progressChart">
                        <!-- Progress charts will be populated here -->
                    </div>
                </div>

                <!-- Study Time Analytics -->
                <div class="glass-card rounded-3xl p-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">⏰ Analisis Waktu Belajar</h3>
                    <div class="space-y-4" id="studyTimeAnalytics">
                        <!-- Analytics will be populated here -->
                    </div>
                </div>

                <div class="glass-card rounded-3xl p-8 lg:col-span-2">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">🧠 Wawasan Kinerja</h3>
                    <div class="grid md:grid-cols-2 gap-6" id="performanceInsights">
                        <!-- Performance insights will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Notification -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>

    <!-- JavaScript -->
    <script>
        // Global variables
        let currentUser = null;
        let studyData = {
            subjects: [],
            studyTime: 0,
            streak: 0,
            goals: []
        };
        let timerInterval = null;
        let timerMinutes = 25;
        let timerSeconds = 0;
        let isTimerRunning = false;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        // Tambahkan variabel global untuk waktu berjalan
        let runningTimerElapsed = 0;
        // Tambahkan audio bell
        const bellAudio = new Audio('bell100%.mp3');

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            if (currentUser) {
                document.getElementById('nameModal').classList.remove('show');
                initializeApp();
            }
            window.lastContinuedSubjectName = null;
            window.lastContinuedSubjectIndex = null;
            updateActiveSubjectName();
            renderFAQQuestions(); // Render FAQ questions when the page loads
        });

        // Name input handling
        function handleNameKeyPress(event) {
            if (event.key === 'Enter') {
                saveName();
            }
        }

        function saveName() {
            const nameInput = document.getElementById('nameInput');
            const name = nameInput.value.trim();
            
            if (name) {
                currentUser = name;
                localStorage.setItem('eduMentorUser', name);
                document.getElementById('nameModal').classList.remove('show');
                showNotification(`Selamat datang, ${name}! 🎉`);
                initializeApp();
            } else {
                showNotification('Silakan masukkan nama Anda terlebih dahulu', 'error');
            }
        }

        function loadUserData() {
            const savedUser = localStorage.getItem('eduMentorUser');
            if (savedUser) {
                currentUser = savedUser;
                const savedData = localStorage.getItem(`eduMentorData_${savedUser}`);
                if (savedData) {
                    studyData = JSON.parse(savedData);
                    // Patch: pastikan setiap subject punya targetTime
                    if (studyData.subjects && Array.isArray(studyData.subjects)) {
                        studyData.subjects.forEach(subject => {
                            if (!subject.targetTime || isNaN(parseFloat(subject.targetTime))) {
                                subject.targetTime = subject.studyTime || 25;
                            }
                            if (!subject.totalTime || isNaN(parseFloat(subject.totalTime))) {
                                subject.totalTime = 0;
                            }
                            if (!subject.lastMilestone || isNaN(parseFloat(subject.lastMilestone))) {
                                subject.lastMilestone = 0;
                            }
                            if (!subject.runningTimerElapsed || isNaN(parseFloat(subject.runningTimerElapsed))) {
                                subject.runningTimerElapsed = 0;
                            }
                        });
                    }
                }
            }
        }

        function saveUserData() {
            if (currentUser) {
                localStorage.setItem(`eduMentorData_${currentUser}`, JSON.stringify(studyData));
            }
        }

        function initializeApp() {
            document.getElementById('userName').textContent = currentUser;
            updateDashboard();
            generateCalendar();
            loadAIRecommendations();
            initializeDefaultSubjects();
        }

        // 1. Add lastMilestone to each subject (for new and default subjects)
        function initializeDefaultSubjects() {
            if (studyData.subjects.length === 0) {
                studyData.subjects = [
                    {
                        name: 'Matematika',
                        description: 'Konsep dasar matematika',
                        difficulty: 'intermediate',
                        progress: 65,
                        totalTime: 120,
                        completed: false,
                        studyTime: 25,
                        targetTime: 120,
                        lastMilestone: 0,
                        runningTimerElapsed: 0
                    },
                    {
                        name: 'Pemrograman',
                        description: 'Belajar dasar pemrograman',
                        difficulty: 'beginner',
                        progress: 30,
                        totalTime: 80,
                        completed: false,
                        studyTime: 25,
                        targetTime: 80,
                        lastMilestone: 0,
                        runningTimerElapsed: 0
                    },
                    {
                        name: 'Ilmu Data',
                        description: 'Pengenalan ilmu data',
                        difficulty: 'advanced',
                        progress: 15,
                        totalTime: 40,
                        completed: false,
                        studyTime: 25,
                        targetTime: 40,
                        lastMilestone: 0,
                        runningTimerElapsed: 0
                    }
                ];
                saveUserData();
            }
        }

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'learning-path') {
                updateLearningPath();
            } else if (tabName === 'study-planner') {
                updateStudyPlanner();
            } else if (tabName === 'analytics') {
                updateAnalytics();
            }
        }

        // Subject management
        function openSubjectModal() {
            document.getElementById('subjectModal').classList.add('show');
        }

        function closeSubjectModal() {
            document.getElementById('subjectModal').classList.remove('show');
            document.getElementById('subjectName').value = '';
            document.getElementById('subjectDescription').value = '';
            document.getElementById('subjectDifficulty').value = 'beginner';
            document.getElementById('subjectTime').value = 25; // Reset timer option
        }

        // 2. Update progress calculation and milestone logic in updateTimer
        function addNewSubject() {
            const name = document.getElementById('subjectName').value.trim();
            const description = document.getElementById('subjectDescription').value.trim();
            const difficulty = document.getElementById('subjectDifficulty').value;
            const time = parseInt(document.getElementById('subjectTime').value);
            // Cek nama subject sudah ada (case-insensitive)
            const nameExists = studyData.subjects.some(s => s.name.trim().toLowerCase() === name.toLowerCase());
            if (nameExists) {
                Swal.fire('Gagal', 'Nama mata pelajaran sudah ada, gunakan nama lain!', 'error');
                return;
            }
            if (name && description && time > 0) {
                const newSubject = {
                    name: name,
                    description: description,
                    difficulty: difficulty,
                    progress: 0,
                    totalTime: 0,
                    completed: false,
                    studyTime: time,
                    targetTime: time,
                    lastMilestone: 0, // milestone progress
                    runningTimerElapsed: 0,
                    timestamp: Date.now() // Add timestamp for sorting
                };
                studyData.subjects.push(newSubject);
                saveUserData();
                closeSubjectModal();
                // Reset to first page when adding new subject
                window.currentSchedulePage = 1;
                updateDashboard();
                showNotification(`Mata pelajaran "${name}" berhasil ditambahkan! 📚`);
            } else {
                showNotification('Silakan lengkapi semua field', 'error');
            }
        }

        // Dashboard updates
        function updateDashboard() {
            updateMetrics();
            updateTodaySchedule();
            updatePrioritySubjects();
        }

        function updateMetrics() {
            const totalSubjects = studyData.subjects.length;
            const completedSubjects = studyData.subjects.filter(s => s.completed).length;
            const overallProgress = totalSubjects > 0 ? 
                Math.round(studyData.subjects.reduce((sum, s) => sum + s.progress, 0) / totalSubjects) : 0;
            
            document.getElementById('overallProgress').textContent = `${overallProgress}%`;
            document.getElementById('completedCourses').textContent = completedSubjects;
            document.getElementById('studyTime').textContent = `${Math.round(studyData.studyTime / 60)}h`;
            document.getElementById('studyStreak').textContent = studyData.streak;
        }

        // 3. On dashboard render, always use lastMilestone as minimum progress
        function updateTodaySchedule() {
            const scheduleContainer = document.getElementById('todaySchedule');
            scheduleContainer.innerHTML = '';
            
            if (studyData.subjects.length === 0) {
                scheduleContainer.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-500">Belum ada mata pelajaran. Klik "Tambah Mata Pelajaran" untuk menambahkan.</p>
                    </div>
                `;
                // Sembunyikan tombol aksi jika tidak ada subject
                const actions = document.getElementById('selectedActions');
                if (actions) actions.style.display = 'none';
                return;
            }
            
            // Siapkan array untuk menampung id subject terpilih
            if (!window.selectedSubjectIndexes) window.selectedSubjectIndexes = [];
            
            // Sort subjects: newest first (by creation time or add timestamp)
            const sortedSubjects = [...studyData.subjects].sort((a, b) => {
                // If subjects have timestamp, sort by timestamp, otherwise keep original order
                if (a.timestamp && b.timestamp) {
                    return b.timestamp - a.timestamp;
                }
                // For existing subjects without timestamp, newer ones (higher index) come first
                return studyData.subjects.indexOf(b) - studyData.subjects.indexOf(a);
            });
            
            // Pagination variables
            const itemsPerPage = 10;
            const currentPage = window.currentSchedulePage || 1;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedSubjects = sortedSubjects.slice(startIndex, endIndex);
            
            // Render paginated subjects
            paginatedSubjects.forEach((subject, displayIndex) => {
                const originalIndex = studyData.subjects.indexOf(subject);
                const scheduleItem = document.createElement('div');
                let totalTime = (parseFloat(subject.totalTime) || 0) + (parseFloat(subject.runningTimerElapsed) || 0);
                let targetTime = parseFloat(subject.targetTime);
                if (!targetTime || isNaN(targetTime)) targetTime = 25;
                let progressRaw = (totalTime / targetTime) * 100;
                let progress = Math.floor(progressRaw);
                if (progress > 100) progress = 100;
                if (progress < 0 || isNaN(progress)) progress = 0;
                // Use lastMilestone as minimum progress
                if (subject.lastMilestone && progress < subject.lastMilestone) {
                    progress = subject.lastMilestone;
                }
                subject.progress = progress;
                subject.completed = (progress === 100);
                scheduleItem.className = 'learning-path-item p-4 mb-4';
                scheduleItem.setAttribute('data-subject-name', subject.name); // Tambahkan atribut unik
                if (subject.completed) scheduleItem.classList.add('completed');
                // Checkbox centang
                const checked = window.selectedSubjectIndexes.includes(originalIndex) ? 'checked' : '';
                scheduleItem.innerHTML = `
                    <div class="flex items-center justify-between gap-2">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" onchange="toggleSelectSubject(${originalIndex})" ${checked} style="margin-right:8px;transform:scale(1.2);" />
                            <div>
                                <h4 class="font-bold text-gray-800">${subject.name}</h4>
                                <p class="text-sm text-gray-600">${subject.description}</p>
                                <div class="flex items-center space-x-2 mt-2">
                                    <span class="skill-badge">${subject.difficulty}</span>
                                    <span class="text-sm text-gray-500">Target: ${subject.targetTime || subject.studyTime || 25} menit</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-purple-600">${progress}%</div>
                            <div class="w-20 h-2 bg-gray-200 rounded-full mt-2">
                                <div class="h-full bg-purple-600 rounded-full" style="width: ${progress}%"></div>
                            </div>
                            <button class="btn-primary mt-2" onclick="continueStudy('${subject.name}')">Lanjutkan</button>
                        </div>
                    </div>
                `;
                
                scheduleContainer.appendChild(scheduleItem);
            });
            
            // Add pagination controls
            const totalPages = Math.ceil(sortedSubjects.length / itemsPerPage);
            if (totalPages > 1) {
                const paginationDiv = document.createElement('div');
                paginationDiv.className = 'flex justify-center items-center space-x-2 mt-6';
                paginationDiv.innerHTML = `
                    <button class="btn-primary" onclick="changeSchedulePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} style="${currentPage === 1 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">❮ Sebelumnya</button>
                    <span class="text-gray-600 font-medium">Halaman ${currentPage} dari ${totalPages}</span>
                    <button class="btn-primary" onclick="changeSchedulePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} style="${currentPage === totalPages ? 'opacity: 0.5; cursor: not-allowed;' : ''}">Selanjutnya ❯</button>
                `;
                scheduleContainer.appendChild(paginationDiv);
            }
            
            // Tampilkan/sembunyikan tombol aksi sesuai jumlah centang
            const actions = document.getElementById('selectedActions');
            if (actions) {
                if (window.selectedSubjectIndexes.length > 0) {
                    actions.style.display = '';
                } else {
                    actions.style.display = 'none';
                }
            }
        }

        function updatePrioritySubjects() {
            const prioritySelect = document.getElementById('prioritySubject');
            prioritySelect.innerHTML = '';
            
            studyData.subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.name;
                option.textContent = subject.name;
                prioritySelect.appendChild(option);
            });
        }

        // Timer functions
        function startTimer() {
            if (!isTimerRunning) {
                isTimerRunning = true;
                document.getElementById('timerBtn').textContent = 'Paus';
                timerInterval = setInterval(updateTimer, 1000);
                document.getElementById('timerSelect').disabled = true;
                runningTimerElapsed = 0;
            } else {
                isTimerRunning = false;
                document.getElementById('timerBtn').textContent = 'Lanjutkan';
                clearInterval(timerInterval);
                document.getElementById('timerSelect').disabled = false;
            }
        }

        // 2. Update progress calculation and milestone logic in updateTimer
        function updateTimer() {
            if (timerSeconds === 0) {
                if (timerMinutes === 0) {
                    // Timer selesai
                    if (typeof window.lastContinuedSubjectIndex === 'number' && studyData.subjects[window.lastContinuedSubjectIndex]) {
                        const subject = studyData.subjects[window.lastContinuedSubjectIndex];
                        subject.totalTime += subject.runningTimerElapsed || 0;
                        subject.runningTimerElapsed = 0;
                        saveUserData();
                    }
                    resetTimer();
                    showNotification('Sesi selesai! Istirahat! 🎉');
                    updateMetrics();
                    updateDashboard();
                    return;
                }
                timerMinutes--;
                timerSeconds = 59;
            } else {
                timerSeconds--;
            }
            const display = `${timerMinutes.toString().padStart(2, '0')}:${timerSeconds.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').textContent = display;
            // Milestone progress logic
            if (typeof window.lastContinuedSubjectIndex === 'number' && studyData.subjects[window.lastContinuedSubjectIndex]) {
                const subject = studyData.subjects[window.lastContinuedSubjectIndex];
                let totalTime = (parseFloat(subject.totalTime) || 0) + (parseFloat(subject.runningTimerElapsed) || 0);
                let targetTime = parseFloat(subject.targetTime);
                if (!targetTime || isNaN(targetTime)) targetTime = 25;
                let durasiAwal = parseInt(document.getElementById('timerSelect').value) || 25;
                runningTimerElapsed += 1/60; // 1 detik = 1/60 menit
                let progressRaw = ((totalTime + runningTimerElapsed) / targetTime) * 100;
                let progress = Math.floor(progressRaw);
                if (progress > 100) progress = 100;
                if (progress < 0 || isNaN(progress)) progress = 0;
                // Milestone logic
                const milestones = [25, 50, 75, 100];
                let milestoneReached = subject.lastMilestone || 0;
                for (let i = 0; i < milestones.length; i++) {
                    if (progress >= milestones[i] && milestoneReached < milestones[i]) {
                        milestoneReached = milestones[i];
                        subject.lastMilestone = milestoneReached;
                        saveUserData();
                        showNotification(`Selamat! Anda telah mencapai ${milestoneReached}% dari target! 🎉`);
                        // Bunyi lonceng jika 100%
                        if (milestoneReached === 100) {
                            bellAudio.play();
                        }
                        break;
                    }
                }
                // If progress is less than lastMilestone (e.g. after refresh), revert to lastMilestone
                if (progress < subject.lastMilestone) {
                    progress = subject.lastMilestone;
                }
                subject.progress = progress;
                subject.completed = (progress === 100);
                // Jika sudah 100%, otomatis pause timer
                if (subject.completed) {
                    isTimerRunning = false;
                    clearInterval(timerInterval);
                    document.getElementById('timerBtn').textContent = 'Mulai';
                    document.getElementById('timerSelect').disabled = false;
                }
                // Update progress bar and % in DOM
                const scheduleContainer = document.getElementById('todaySchedule');
                if (scheduleContainer) {
                    const cards = scheduleContainer.querySelectorAll('.learning-path-item');
                    const card = cards[window.lastContinuedSubjectIndex];
                    if (card) {
                        const percentEl = card.querySelector('.text-2xl.font-bold.text-purple-600');
                        if (percentEl) percentEl.textContent = progress + '%';
                        const barEl = card.querySelector('.h-full.bg-purple-600.rounded-full');
                        if (barEl) barEl.style.width = progress + '%';
                        if (progress === 100) card.classList.add('completed');
                        else card.classList.remove('completed');
                        // Update teks waktu belajar real-time
                        const timeEl = document.getElementById(`subject-time-${window.lastContinuedSubjectIndex}`);
                        if (timeEl) timeEl.textContent = `${Math.floor(totalTime + runningTimerElapsed)} menit belajar`;
                    }
                }
                // Simpan waktu berjalan ke localStorage setiap detik
                saveUserData();
                updateActiveSubjectProgress(subject.name, progress);
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            isTimerRunning = false;
            timerMinutes = timerMinutes; // Keep the duration set by the subject
            timerSeconds = 0;
            document.getElementById('timerDisplay').textContent = `${timerMinutes.toString().padStart(2, '0')}:00`;
            document.getElementById('timerBtn').textContent = 'Mulai';
            document.getElementById('timerSelect').disabled = false;
            runningTimerElapsed = 0;
        }

        function changeTimerDuration() {
            timerMinutes = parseInt(document.getElementById('timerSelect').value);
            timerSeconds = 0;
            document.getElementById('timerDisplay').textContent = `${timerMinutes.toString().padStart(2, '0')}:00`;
        }

        function addMessageToChat(message, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-bubble ${sender}-message`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="text-right">
                        <div class="font-semibold text-white mb-1">${currentUser}</div>
                        <div class="text-white">${message}</div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm">🤖</span>
                        </div>
                        <div>
                            <div class="font-semibold text-gray-800 mb-1">EduMentor Chatbot</div>
                            <div class="text-gray-700">${message}</div>
                        </div>
                    </div>
                `;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Calendar functions
        function generateCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            document.getElementById('calendarMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            calendarGrid.innerHTML = '';
            
            // Day headers
            const dayHeaders = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
            dayHeaders.forEach(day => {
                const headerDiv = document.createElement('div');
                headerDiv.className = 'calendar-day font-bold text-gray-600';
                headerDiv.textContent = day;
                calendarGrid.appendChild(headerDiv);
            });
            
            // Empty days
            for (let i = 0; i < firstDay; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'calendar-day';
                calendarGrid.appendChild(emptyDiv);
            }
            
            // Days of month
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.textContent = day;
                
                if (currentYear === today.getFullYear() && 
                    currentMonth === today.getMonth() && 
                    day === today.getDate()) {
                    dayDiv.classList.add('today');
                }
                
                // Random study sessions for demo
                if (Math.random() > 0.7) {
                    dayDiv.classList.add('has-session');
                }
                
                calendarGrid.appendChild(dayDiv);
            }
        }

        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            generateCalendar();
        }

        // Learning path functions
        function updateLearningPath() {
            const learningPathContainer = document.getElementById('learningPaths');
            learningPathContainer.innerHTML = '';
            
            studyData.subjects.forEach((subject, index) => {
                const pathItem = document.createElement('div');
                pathItem.className = 'learning-path-item p-6 mb-6';
                if (subject.completed) pathItem.classList.add('completed');
                else if (index === 0) pathItem.classList.add('current');
                
                pathItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="text-xl font-bold text-gray-800 mb-2">${subject.name}</h4>
                            <p class="text-gray-600 mb-4">${subject.description}</p>
                            <div class="flex items-center space-x-4 mb-4">
                                <span class="skill-badge">${subject.difficulty}</span>
                                <span class="text-sm text-gray-500">${subject.totalTime} menit belajar</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-purple-600 h-3 rounded-full transition-all duration-300" 
                                     style="width: ${subject.progress}%"></div>
                            </div>
                        </div>
                        <div class="text-right ml-6">
                            <div class="text-3xl font-bold text-purple-600">${subject.progress}%</div>
                            <button class="btn-primary mt-4" onclick="continueStudy('${subject.name}')">
                                Lanjutkan
                            </button>
                        </div>
                    </div>
                `;
                
                learningPathContainer.appendChild(pathItem);
            });
        }

        function continueStudy(subjectName) {
            const subjectIndex = studyData.subjects.findIndex(s => s.name === subjectName);
            if (subjectIndex !== -1) {
                window.lastContinuedSubjectName = subjectName;
                window.lastContinuedSubjectIndex = subjectIndex;
                const subject = studyData.subjects[subjectIndex];
                // Selalu gunakan timer default 25 menit setiap mulai sesi
                timerMinutes = 25;
                timerSeconds = 0;
                document.getElementById('timerDisplay').textContent = `25:00`;
                document.getElementById('timerSelect').disabled = true;
                if (!isTimerRunning) startTimer();
                saveUserData();
                updateDashboard();
                updateActiveSubjectName();
            }
        }

        // Study planner functions
        function updateStudyPlanner() {
            updatePrioritySubjects();
            updateStudyGoals();
        }

        function updateStudyGoals() {
            const goalsContainer = document.getElementById('studyGoals');
            goalsContainer.innerHTML = '';
            
            if (studyData.goals.length === 0) {
                studyData.goals = [
                    { text: 'Selesaikan 2 jam belajar harian', completed: false },
                    { text: 'Selesaikan kursus Matematika', completed: false },
                    { text: 'Pelajari 5 konsep baru pemrograman', completed: false }
                ];
                saveUserData();
            }
            
            studyData.goals.forEach((goal, index) => {
                const goalDiv = document.createElement('div');
                goalDiv.className = `p-3 rounded-lg border-2 ${goal.completed ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`;
                goalDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="${goal.completed ? 'line-through text-gray-500' : 'text-gray-800'}">${goal.text}</span>
                        <input type="checkbox" ${goal.completed ? 'checked' : ''} 
                               onchange="toggleGoal(${index})" class="ml-2">
                    </div>
                `;
                goalsContainer.appendChild(goalDiv);
            });
        }

        function toggleGoal(index) {
            studyData.goals[index].completed = !studyData.goals[index].completed;
            saveUserData();
            updateStudyGoals();
        }

        function addNewGoal() {
            const goalText = prompt('Masukkan tujuan belajar Anda:');
            if (goalText) {
                studyData.goals.push({ text: goalText, completed: false });
                saveUserData();
                updateStudyGoals();
                showNotification('Tujuan baru ditambahkan! 🎯');
            }
        }

        function generateSchedule() {
            const availableTime = document.getElementById('availableTime').value;
            const learningStyle = document.getElementById('learningStyle').value;
            const prioritySubject = document.getElementById('prioritySubject').value;
            
            showNotification('AI sedang menghasilkan jadwal optimal Anda... 🤖');
            
            // Simulate AI processing
            setTimeout(() => {
                showNotification('Jadwal berhasil dihasilkan! Periksa kalender Anda. 📅');
                // In a real app, this would call the AI API to generate an actual schedule
            }, 2000);
        }

        // Analytics functions
        function updateAnalytics() {
            updateProgressChart();
            updateStudyTimeAnalytics();
            updatePerformanceInsights();
        }

        function updateProgressChart() {
            const chartContainer = document.getElementById('progressChart');
            chartContainer.innerHTML = '';
            
            studyData.subjects.forEach(subject => {
                const chartItem = document.createElement('div');
                chartItem.className = 'mb-4';
                chartItem.innerHTML = `                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-gray-800">${subject.name}</span>
                        <span class="text-purple-600 font-bold">${subject.progress}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="bg-gradient-to-r from-purple-500 to-blue-500 h-4 rounded-full transition-all duration-500" 
                             style="width: ${subject.progress}%"></div>
                    </div>
                `;
                chartContainer.appendChild(chartItem);
            });
        }

        function updateStudyTimeAnalytics() {
            const analyticsContainer = document.getElementById('studyTimeAnalytics');
            analyticsContainer.innerHTML = '';
            
            const totalTime = studyData.studyTime;
            const averageSession = totalTime > 0 ? Math.round(totalTime / 7) : 0;
            
            const analytics = [
                { label: 'Waktu Belajar Total', value: `${Math.round(totalTime / 60)}h ${totalTime % 60}m`, color: 'blue' },
                { label: 'Rata-rata Sesi', value: `${averageSession}m`, color: 'green' },
                { label: 'Streak Belajar', value: `${studyData.streak} hari`, color: 'purple' },
                { label: 'Mata Pelajaran Selesai', value: studyData.subjects.filter(s => s.completed).length, color: 'orange' }
            ];
            
            analytics.forEach(item => {
                const analyticsItem = document.createElement('div');
                analyticsItem.className = 'metric-card';
                analyticsItem.innerHTML = `
                    <div class="text-2xl font-bold text-${item.color}-600 mb-2">${item.value}</div>
                    <div class="text-gray-600 text-sm">${item.label}</div>
                `;
                analyticsContainer.appendChild(analyticsItem);
            });
        }

        function updatePerformanceInsights() {
            const insightsContainer = document.getElementById('performanceInsights');
            insightsContainer.innerHTML = '';
            
            const insights = [
                {
                    title: '📈 Kecepatan Belajar',
                    content: 'Anda belajar 15% lebih cepat dari pembelajar rata-rata!',
                    color: 'green'
                },
                {
                    title: '🎯 Area Fokus',
                    content: 'Pertimbangkan untuk menghabiskan lebih banyak waktu pada topik lanjutan.',
                    color: 'blue'
                },
                {
                    title: '⏰ Waktu Belajar Terbaik',
                    content: 'Kinerja Anda puncak antara 9-11 pagi.',
                    color: 'purple'
                },
                {
                    title: '🏆 Potensi Penghargaan',
                    content: 'Anda hanya 2 sesi lagi dari jadwal berikutnya!',
                    color: 'orange'
                }
            ];
            
            insights.forEach(insight => {
                const insightDiv = document.createElement('div');
                insightDiv.className = 'glass-card p-6 rounded-2xl';
                insightDiv.innerHTML = `
                    <h4 class="text-lg font-bold text-gray-800 mb-3">${insight.title}</h4>
                    <p class="text-gray-600">${insight.content}</p>
                `;
                insightsContainer.appendChild(insightDiv);
            });
        }

        // AI Recommendations
        async function loadAIRecommendations() {
            const recommendationsContainer = document.getElementById('aiRecommendations');
            recommendationsContainer.innerHTML = '<div class="loading-spinner"></div> Memuat rekomendasi...';
            
            try {
                const userContext = `Pengguna: ${currentUser}, Mata Pelajaran: ${studyData.subjects.map(s => s.name).join(', ')}, 
                                   Waktu Belajar: ${studyData.studyTime}menit, Progres: ${studyData.subjects.map(s => s.progress).join(', ')}%`;
                
                const response = await callGeminiAPI(`Berikan 3 rekomendasi belajar pendek berdasarkan: ${userContext}`);
                
                // Parse the response and create recommendation items
                const recommendations = response.split('\n').filter(line => line.trim()).slice(0, 3);
                
                recommendationsContainer.innerHTML = '';
                recommendations.forEach(rec => {
                    const recDiv = document.createElement('div');
                    recDiv.className = 'p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400';
                    recDiv.innerHTML = `<p class="text-blue-800 text-sm">${rec}</p>`;
                    recommendationsContainer.appendChild(recDiv);
                });
            } catch (error) {
                recommendationsContainer.innerHTML = `
                    <div class="p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                        <p class="text-blue-800 text-sm">📚 Ulas kembali mata pelajaran yang lemah Anda</p>
                    </div>
                    <div class="p-3 bg-green-50 rounded-lg border-l-4 border-green-400">
                        <p class="text-green-800 text-sm">⏰ Ambil break teratur setiap 25 menit</p>
                    </div>
                    <div class="p-3 bg-purple-50 rounded-lg border-l-4 border-purple-400">
                        <p class="text-purple-800 text-sm">🎯 Tetapkan tujuan belajar harian spesifik</p>
                    </div>
                    <div class="p-3 bg-orange-50 rounded-lg border-l-4 border-orange-400">
                        <p class="text-orange-800 text-sm">✅ Centang mata pelajaran yang ingin dihapus dan direset</p>
                    </div>
                `;
            }
        }

        // Utility functions
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = `notification ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showProfile() {
            Swal.fire({
                title: `Profil: ${currentUser}`,
                html: `<div style='text-align:left'>
                    <b>Waktu Belajar Total:</b> ${Math.round(studyData.studyTime / 60)} jam<br>
                    <b>Mata Pelajaran Selesai:</b> ${studyData.subjects.filter(s => s.completed).length}<br>
                    <b>Streak:</b> ${studyData.streak} hari
                </div>`,
                icon: 'info',
                confirmButtonText: 'Tutup'
            });
        }

        function updateActiveSubjectName() {
            const el = document.getElementById('activeSubjectName');
            if (!el) return;
            if (window.lastContinuedSubjectName) {
                el.textContent = `Sedang belajar: ${window.lastContinuedSubjectName}`;
            } else {
                el.textContent = 'Belum ada jadwal yang dipilih';
            }
        }

        // Fungsi toggle centang subject
        function toggleSelectSubject(index) {
            if (!window.selectedSubjectIndexes) window.selectedSubjectIndexes = [];
            const idx = window.selectedSubjectIndexes.indexOf(index);
            if (idx === -1) {
                window.selectedSubjectIndexes.push(index);
            } else {
                window.selectedSubjectIndexes.splice(idx, 1);
            }
            updateTodaySchedule(); // update visibilitas tombol aksi
        }

        // Hapus subject terpilih
        function deleteSelectedSubjects() {
            if (!window.selectedSubjectIndexes || window.selectedSubjectIndexes.length === 0) {
                showNotification('Pilih jadwal yang ingin dihapus!', 'error');
                return;
            }
            Swal.fire({
                title: 'Hapus Jadwal Terpilih?',
                text: 'Yakin ingin menghapus semua jadwal terpilih?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ya, Hapus!',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.selectedSubjectIndexes.sort((a,b)=>b-a).forEach(idx => {
                        studyData.subjects.splice(idx, 1);
                    });
                    window.selectedSubjectIndexes = [];
                    saveUserData();
                    updateDashboard();
                    Swal.fire('Berhasil!','Jadwal terpilih berhasil dihapus!','success');
                }
            });
        }

        // Reset subject terpilih
        function resetSelectedSubjects() {
            if (!window.selectedSubjectIndexes || window.selectedSubjectIndexes.length === 0) {
                showNotification('Pilih jadwal yang ingin direset!', 'error');
                return;
            }
            Swal.fire({
                title: 'Reset Jadwal Terpilih?',
                text: 'Yakin ingin mereset semua jadwal terpilih?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ya, Reset!',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.selectedSubjectIndexes.forEach(idx => {
                        if (studyData.subjects[idx]) {
                            studyData.subjects[idx].totalTime = 0;
                            studyData.subjects[idx].progress = 0;
                            studyData.subjects[idx].completed = false;
                            studyData.subjects[idx].lastMilestone = 0;
                            studyData.subjects[idx].runningTimerElapsed = 0; // Reset waktu berjalan
                        }
                    });
                    saveUserData();
                    updateDashboard();
                    Swal.fire('Berhasil!','Jadwal terpilih berhasil direset!','success');
                    // Reset timer belajar ke default
                    timerMinutes = parseInt(document.getElementById('timerSelect').value) || 25;
                    timerSeconds = 0;
                    document.getElementById('timerDisplay').textContent = `${timerMinutes.toString().padStart(2, '0')}:00`;
                    document.getElementById('timerSelect').disabled = false;
                    document.getElementById('timerBtn').textContent = 'Mulai';
                    isTimerRunning = false;
                    clearInterval(timerInterval);
                    // Reset label subject aktif
                    window.lastContinuedSubjectName = null;
                    window.lastContinuedSubjectIndex = null;
                    updateActiveSubjectName();
                }
            });
        }

        // FAQ Chatbot Data
        const faqData = [
            {
                q: 'Bagaimana cara menambah mata pelajaran?',
                a: 'Klik tombol "+ Tambah Mata Pelajaran" di dashboard, isi data yang diperlukan, lalu klik "Tambah".'
            },
            {
                q: 'Bagaimana cara mengatur timer belajar?',
                a: 'Pilih durasi timer di dropdown pada panel Timer Belajar, lalu klik "Mulai" untuk memulai sesi.'
            },
            {
                q: 'Bagaimana cara menghapus atau mereset mata pelajaran?',
                a: 'Centang mata pelajaran yang ingin dihapus atau direset, lalu klik tombol "Hapus Terpilih" atau "Reset Terpilih".'
            },
            {
                q: 'Apa itu progres belajar dan bagaimana cara meningkatkannya?',
                a: 'Progres belajar adalah persentase waktu belajar terhadap target. Tingkatkan dengan menyelesaikan sesi belajar.'
            },
            {
                q: 'Bagaimana cara melihat analitik belajar saya?',
                a: 'Buka tab "Analitik" untuk melihat grafik progres, waktu belajar, dan wawasan kinerja.'
            },
            {
                q: 'Bagaimana cara menggunakan perencana belajar?',
                a: 'Buka tab "Perencana Belajar", atur preferensi, lalu klik "Hasilkan Jadwal Optimal".'
            },
            {
                q: 'Bagaimana cara menambah tujuan belajar?',
                a: 'Di tab "Perencana Belajar", klik "+ Tambah Tujuan Baru" dan masukkan tujuan Anda.'
            },
            {
                q: 'Bagaimana cara melanjutkan belajar pada mata pelajaran tertentu?',
                a: 'Klik tombol "Lanjutkan" pada mata pelajaran yang ingin Anda pelajari di dashboard.'
            },
            {
                q: 'Apa itu milestone dan bagaimana cara mencapainya?',
                a: 'Milestone adalah pencapaian progres belajar (25%, 50%, 75%, 100%). Capai dengan menyelesaikan sesi belajar secara konsisten.'
            },
            {
                q: 'Bagaimana cara mengoptimalkan waktu belajar?',
                a: 'Gunakan teknik Pomodoro (25 menit fokus), istirahat teratur, dan fokus pada satu mata pelajaran per sesi.'
            },
            {
                q: 'Apa manfaat dari tracking progres belajar?',
                a: 'Tracking progres membantu Anda melihat kemajuan, mengidentifikasi area yang perlu perbaikan, dan tetap termotivasi.'
            },
            {
                q: 'Bagaimana cara mengatasi kebosanan saat belajar?',
                a: 'Variasikan mata pelajaran, gunakan timer untuk sesi pendek, dan tetapkan tujuan kecil yang mudah dicapai.'
            },
            {
                q: 'Apa itu streak belajar dan bagaimana mempertahankannya?',
                a: 'Streak adalah jumlah hari berturut-turut Anda belajar. Pertahankan dengan belajar minimal 1 sesi per hari.'
            },
            {
                q: 'Bagaimana cara mengatur prioritas mata pelajaran?',
                a: 'Identifikasi mata pelajaran yang paling sulit atau penting, lalu alokasikan lebih banyak waktu untuk itu.'
            },
            {
                q: 'Apa tips untuk belajar yang efektif?',
                a: 'Buat jadwal teratur, gunakan teknik active recall, review materi secara berkala, dan istirahat yang cukup.'
            },
            {
                q: 'Bagaimana cara mengukur keberhasilan belajar?',
                a: 'Lihat progres di dashboard, catat milestone yang dicapai, dan evaluasi pemahaman materi secara berkala.'
            }
        ];

        // Render FAQ Questions
        function renderFAQQuestions() {
            const faqContainer = document.getElementById('faqQuestions');
            faqContainer.innerHTML = '';
            faqData.forEach((item, idx) => {
                const btn = document.createElement('button');
                btn.className = 'p-4 bg-blue-50 rounded-lg border-2 border-blue-200 hover:border-blue-400 transition-all text-left';
                btn.onclick = function() { sendFAQMessage(item.q); };
                btn.innerHTML = `<div class="font-semibold text-blue-800">${item.q}</div>`;
                faqContainer.appendChild(btn);
            });
        }

        // Chatbot send message (FAQ)
        function sendFAQMessage(msg) {
            let message = msg;
            if (!message) return;
            addMessageToChat(message, 'user');
            // Cari jawaban
            const found = faqData.find(item => item.q.toLowerCase() === message.toLowerCase());
            let answer = found ? found.a : 'Maaf, pertanyaan tidak tersedia. Silakan pilih dari daftar.';
            setTimeout(() => {
                addMessageToChat(answer, 'ai');
            }, 400);
        }



        // Pagination function for schedule
        function changeSchedulePage(page) {
            if (page < 1) return;
            const totalPages = Math.ceil(studyData.subjects.length / 10);
            if (page > totalPages) return;
            window.currentSchedulePage = page;
            updateTodaySchedule();
        }

        // Auto-save data every 30 seconds
        setInterval(saveUserData, 30000);

        function updateActiveSubjectProgress(subjectName, progress) {
            const scheduleContainer = document.getElementById('todaySchedule');
            if (!scheduleContainer) return;
            const card = scheduleContainer.querySelector(`.learning-path-item[data-subject-name="${subjectName.replace(/"/g, '\"')}"]`);
            if (card) {
                const percentEl = card.querySelector('.text-2xl.font-bold.text-purple-600');
                if (percentEl) percentEl.textContent = progress + '%';
                const barEl = card.querySelector('.h-full.bg-purple-600.rounded-full');
                if (barEl) barEl.style.width = progress + '%';
            }
        }
    </script>
</body>
</html>